version: '3.9'

services:
  ton-config-init:
    image: curlimages/curl:8.12.1
    container_name: ton-config-init
    restart: "no"
    environment:
      TON_LITESERVER_CONFIG_DOWNLOAD_URL: ${TON_LITESERVER_CONFIG_DOWNLOAD_URL:-https://ton.org/global-config.json}
      TON_FORCE_REFRESH_CONFIG: ${TON_FORCE_REFRESH_CONFIG:-0}
    volumes:
      - ./ton-lite:/ton-lite
    entrypoint: ["/bin/sh", "-c"]
    command: >
      set -e;
      if [ "$${TON_FORCE_REFRESH_CONFIG}" != "1" ] && [ -s /ton-lite/global-config.json ]; then
        echo "Using existing /ton-lite/global-config.json";
        exit 0;
      fi;
      echo "Fetching TON lite config from $${TON_LITESERVER_CONFIG_DOWNLOAD_URL}";
      curl -fsSL "$${TON_LITESERVER_CONFIG_DOWNLOAD_URL}" -o /ton-lite/global-config.json;
      grep -q '"liteservers"' /ton-lite/global-config.json;
      echo "Saved /ton-lite/global-config.json"

  redis:
    image: redis:7-alpine
    container_name: ton-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1000", "--appendonly", "yes"]
    volumes:
      - ton_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ton-http-api:
    image: toncenter/ton-http-api:latest
    container_name: ton-http-api
    restart: unless-stopped
    depends_on:
      ton-config-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    environment:
      # Public host you expose via reverse proxy (nginx/caddy/traefik)
      TON_API_PUBLIC_HOST: ton.kingofthehill.pro
      TON_API_PORT: 8081
      TON_API_ROOT_PATH: /

      # TON HTTP API runtime
      TON_API_CACHE_ENABLED: "1"
      TON_API_CACHE_REDIS_ENDPOINT: redis
      TON_API_CACHE_REDIS_PORT: 6379
      TON_API_LOGS_LEVEL: INFO
      TON_API_JSON_RPC_ENABLED: "1"
      TON_API_GET_METHODS_ENABLED: "1"
      # Prefer a local config file so startup is not coupled to public config hosts.
      # Provide TON_LITESERVER_CONFIG_URL in .env when you want to override this path.
      TON_API_TONLIB_LITESERVER_CONFIG: ${TON_LITESERVER_CONFIG_URL:-/opt/ton-config/global-config.json}
      TON_API_TONLIB_KEYSTORE: /tmp/ton-keystore
      # Conservative defaults reduce worker crashes when ADNL connectivity is unstable.
      TON_API_TONLIB_PARALLEL_REQUESTS_PER_LITESERVER: ${TON_PARALLEL_REQUESTS_PER_LITESERVER:-2}
      TON_API_TONLIB_REQUEST_TIMEOUT: ${TON_REQUEST_TIMEOUT_SECONDS:-30}

      # Optional API key protection for public access
      TON_API_KEY: ${TON_API_KEY:-}
    ports:
      - "8081:8081"
    volumes:
      - ./ton-lite:/opt/ton-config:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8081/health"]
      interval: 15s
      timeout: 5s
      retries: 10

  watchtower:
    image: containrrr/watchtower:latest
    container_name: ton-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 300 ton-http-api redis

volumes:
  ton_redis_data:
